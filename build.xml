<?xml version="1.0"?>

<project name="agavi" basedir="." default="main">

	<!-- set up some stuff -->
  <property environment="env"/>
  <property file="build.properties"/>
  <property name="package"  value="${phing.project.name}" override="true" />
  <property name="builddir" value="build" override="true" />
  <property name="srcdir"   value="${project.basedir}" override="true" />
	<taskdef classname="etc.phing.AgaviPackageTask" name="agavipackage"/>
	<taskdef classname="src.buildtools.phing.AgaviTestTask" name="agavitest"/>

  <!-- fileset for -dist files -->
  <fileset dir="." id="distfiles">
		<include name="**/*-dist"/>
  </fileset>

  <!-- main target -->
	<target name="main" description="main target">
		<echo msg="available targets: " /> 
		<echo msg="  docs    : regenerate phpdocs   " />
		<echo msg="  test    : run unit test suite  " />
		<echo msg="  package : generate PEAR package" />
		<echo msg="  clean   : clean out cruft      " />
	</target>

	<target name="docs" description="docs target">
		<phpdoc title="Agavi Documentation" destdir="apidocs" sourcepath="src" output="HTML:frames:earthli"/>
	</target>

	<target name="manual-html" >
		<mkdir dir="manual-html" />
		<copy file="docs/lib/agavi-manual.css" todir="manual-html" overwrite="true" />
		<xslt file="docs/docbook/manual.xml" todir="manual-html" style="docs/lib/agavi-manual-html.xsl" />
	</target>

	<target name="manual-html-onepage" >
		<mkdir dir="manual-html" />
		<copy file="docs/lib/agavi-manual.css" todir="manual-html" overwrite="true" />
		<xslt file="docs/docbook/manual.xml" todir="manual-html" style="docs/lib/agavi-manual-html-onepage.xsl" />
	</target>
	
	<target name="manual-fo" >
		<mkdir dir="manual-fo" />
		<xslt file="docs/docbook/manual.xml" tofile="manual-fo/manual.fo" style="docs/lib/agavi-manual-fo.xsl" />
	</target>

	<target name="package" description="build pear package">
		<!-- prepare -->
		<delete dir="${builddir}" includeemptydirs="true" verbose="true" failonerror="false" />
		<mkdir dir="${builddir}" />
		<copy todir="${builddir}" >
			<fileset dir="src/">
				<exclude name="**/*.svn" />
				<include name="**/**" />
			</fileset>
		</copy>
		<copy file="CHANGELOG" todir="${builddir}" />
		<copy file="RELEASE_NOTES" todir="${builddir}" />
		<copy file="INSTALL" todir="${builddir}" />
		<copy file="LICENSE" todir="${builddir}" />
		<mkdir dir="${builddir}/scripts" />
		<copy file="etc/agavi-dist" todir="${builddir}/scripts" />
		<copy file="etc/agavi.bat-dist" todir="${builddir}/scripts" />

		<!-- generate package.xml -->
		<agavipackage dir="${builddir}" />

		<!-- fix package.xml -->
		<reflexive file="${builddir}/package.xml"> 
			<filterchain>
				<replaceregexp>
					<regexp pattern="role=&quot;data&quot;" replace="role=&quot;php&quot;" />
				</replaceregexp>
			</filterchain>
		</reflexive>
		<echo msg="package.xml generated to '${builddir}'. Use &quot;pear package&quot; to create the package." />
	</target>

	<target name="test" description="run test suite">
		<agavitest exit="true"/>
	</target>

	<target name="clean" description="clean out the cruft">
		<delete dir="build" includeemptydirs="true" failonerror="true" />
		<delete dir="apidocs" includeemptydirs="true" quiet="true" failonerror="false" />
		<delete file="tests.html" includeemptydirs="true" quiet="true" failonerror="false" />
	</target>

	<target name="damagecontrol" description="damagecontrol target">
		<phingcall target="docs"/>
		<phingcall target="package"/>
		<agavitest exit="true" outfile="tests.html" reporter="html"/>
		<!-- sync docs, packages, tests.html -->
	</target>

</project>
